name: Audit on Issue Comment

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  audit:
    # Trigger when comment contains "/audit"
    if: contains(github.event.comment.body, '/audit')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse audit request
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          CONTRACT=$(echo "$COMMENT" | grep -oP '/audit\s+\K\S+' || echo "")

          if [ -z "$CONTRACT" ]; then
            echo "contract=all" >> $GITHUB_OUTPUT
          else
            echo "contract=$CONTRACT" >> $GITHUB_OUTPUT
          fi

      - name: Run Security Audit
        id: audit
        run: |
          CONTRACT="${{ steps.parse.outputs.contract }}"

          if [ "$CONTRACT" = "all" ]; then
            FILES=$(find contracts -name "*.sol" -type f 2>/dev/null || echo "")
          else
            FILES="$CONTRACT"
          fi

          if [ -z "$FILES" ]; then
            echo "findings=No Solidity files found." >> $GITHUB_OUTPUT
            exit 0
          fi

          FULL_REPORT=""

          for file in $FILES; do
            if [ -f "$file" ]; then
              echo "Auditing $file..."

              # Read contract and escape for JSON
              CONTENT=$(cat "$file" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

              # Call MCP API
              RESPONSE=$(curl -s -X POST \
                "${{ vars.MCP_SERVER_URL }}/api/analyze" \
                -H "Content-Type: application/json" \
                -H "X-API-Key: ${{ secrets.MCP_API_KEY }}" \
                -d "{\"source\": $CONTENT, \"filename\": \"$(basename $file)\"}" \
                --max-time 180 || echo '{"error": "API timeout"}')

              # Extract result
              RESULT=$(echo "$RESPONSE" | python3 -c 'import json,sys; data=json.load(sys.stdin); print(data.get("result", data.get("error", "No response")))' 2>/dev/null || echo "Parse error")

              FULL_REPORT="${FULL_REPORT}

          ### ðŸ“„ ${file}

          \`\`\`
          ${RESULT}
          \`\`\`
          "
            fi
          done

          # Save report to file (GitHub has issues with multiline outputs)
          echo "$FULL_REPORT" > /tmp/audit_report.txt

          # Also save raw findings for Claude
          echo "$FULL_REPORT" > /tmp/raw_findings.txt

      - name: Claude AI Analysis
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the audit findings
          FINDINGS=$(cat /tmp/raw_findings.txt)

          # Check if we have an API key
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "No ANTHROPIC_API_KEY configured - skipping AI analysis"
            echo "## ðŸ¤– Claude Analysis" > /tmp/claude_analysis.txt
            echo "" >> /tmp/claude_analysis.txt
            echo "_AI analysis not available. Add ANTHROPIC_API_KEY secret to enable._" >> /tmp/claude_analysis.txt
            exit 0
          fi

          # Prepare prompt for Claude
          PROMPT=$(cat << 'PROMPT_END'
          Sos un experto en seguridad de smart contracts. AnalizÃ¡ los siguientes findings de una auditorÃ­a automatizada y proporcionÃ¡:

          1. **Resumen Ejecutivo**: Un pÃ¡rrafo con el estado general de seguridad del contrato
          2. **Findings CrÃ­ticos**: Los 3-5 problemas mÃ¡s importantes que deben solucionarse antes de deployar
          3. **Recomendaciones**: Pasos concretos para solucionar cada problema crÃ­tico
          4. **Riesgo General**: Bajo/Medio/Alto/CrÃ­tico con justificaciÃ³n

          SÃ© conciso y prÃ¡ctico. Enfocate en lo que realmente importa para la seguridad.

          FINDINGS DE LA AUDITORÃA:
          PROMPT_END
          )

          # Escape findings for JSON
          ESCAPED_FINDINGS=$(echo "$FINDINGS" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          ESCAPED_PROMPT=$(echo "$PROMPT" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          # Call Claude API
          CLAUDE_RESPONSE=$(curl -s -X POST "https://api.anthropic.com/v1/messages" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 2000,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": ${ESCAPED_PROMPT}\n\n${ESCAPED_FINDINGS}
              }]
            }" --max-time 60 || echo '{"error": "Claude API timeout"}')

          # Extract Claude's response
          ANALYSIS=$(echo "$CLAUDE_RESPONSE" | python3 -c '
          import json, sys
          try:
              data = json.load(sys.stdin)
              if "content" in data and len(data["content"]) > 0:
                  print(data["content"][0].get("text", "No analysis available"))
              elif "error" in data:
                  print(f"Error: {data[\"error\"].get(\"message\", str(data[\"error\"]))}")
              else:
                  print("No analysis available")
          except Exception as e:
              print(f"Parse error: {e}")
          ' 2>/dev/null || echo "Error parsing Claude response")

          # Save Claude's analysis
          echo "## ðŸ¤– Claude Analysis" > /tmp/claude_analysis.txt
          echo "" >> /tmp/claude_analysis.txt
          echo "$ANALYSIS" >> /tmp/claude_analysis.txt

      - name: Post Combined Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let auditReport = '';
            let claudeAnalysis = '';

            try {
              auditReport = fs.readFileSync('/tmp/audit_report.txt', 'utf8');
            } catch (e) {
              auditReport = 'Error reading audit report.';
            }

            try {
              claudeAnalysis = fs.readFileSync('/tmp/claude_analysis.txt', 'utf8');
            } catch (e) {
              claudeAnalysis = '## ðŸ¤– Claude Analysis\n\n_Analysis not available._';
            }

            const fullReport = `# ðŸ” Security Audit Report

            Triggered by: @${{ github.event.comment.user.login }}

            ---

            ${claudeAnalysis}

            ---

            ## ðŸ› ï¸ Automated Findings (Slither + Aderyn + Slang)

            ${auditReport}

            ---

            _Generated by [Solidity Audit MCP](https://github.com/mariano-aguero/solidity-audit-mcp)_
            `;

            // Truncate if too long
            const maxLength = 60000;
            const report = fullReport.length > maxLength
              ? fullReport.substring(0, maxLength) + '\n\n... (truncated)'
              : fullReport;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
