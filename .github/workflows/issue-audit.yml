name: Audit on Issue Comment

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  audit:
    # Trigger when comment contains "/audit"
    if: contains(github.event.comment.body, '/audit')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse audit request
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          CONTRACT=$(echo "$COMMENT" | grep -oP '/audit\s+\K\S+' || echo "")

          if [ -z "$CONTRACT" ]; then
            echo "contract=all" >> $GITHUB_OUTPUT
          else
            echo "contract=$CONTRACT" >> $GITHUB_OUTPUT
          fi

      - name: Run Security Audit
        id: audit
        run: |
          CONTRACT="${{ steps.parse.outputs.contract }}"

          if [ "$CONTRACT" = "all" ]; then
            FILES=$(find contracts -name "*.sol" -type f 2>/dev/null || echo "")
          else
            FILES="$CONTRACT"
          fi

          if [ -z "$FILES" ]; then
            echo "findings=No Solidity files found." >> $GITHUB_OUTPUT
            exit 0
          fi

          FULL_REPORT=""

          for file in $FILES; do
            if [ -f "$file" ]; then
              echo "Auditing $file..."

              # Read contract and escape for JSON
              CONTENT=$(cat "$file" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

              # Call MCP API
              RESPONSE=$(curl -s -X POST \
                "${{ vars.MCP_SERVER_URL }}/api/analyze" \
                -H "Content-Type: application/json" \
                -H "X-API-Key: ${{ secrets.MCP_API_KEY }}" \
                -d "{\"source\": $CONTENT, \"filename\": \"$(basename $file)\"}" \
                --max-time 180 || echo '{"error": "API timeout"}')

              # Extract result
              RESULT=$(echo "$RESPONSE" | python3 -c 'import json,sys; data=json.load(sys.stdin); print(data.get("result", data.get("error", "No response")))' 2>/dev/null || echo "Parse error")

              FULL_REPORT="${FULL_REPORT}

          ### ðŸ“„ ${file}

          \`\`\`
          ${RESULT}
          \`\`\`
          "
            fi
          done

          # Save report to file (GitHub has issues with multiline outputs)
          echo "$FULL_REPORT" > /tmp/audit_report.txt

          # Also save raw findings for Claude
          echo "$FULL_REPORT" > /tmp/raw_findings.txt

      - name: Claude AI Analysis
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Check if we have an API key
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "No ANTHROPIC_API_KEY configured - skipping AI analysis"
            echo "## ðŸ¤– Claude Analysis" > /tmp/claude_analysis.txt
            echo "" >> /tmp/claude_analysis.txt
            echo "_AI analysis not available. Add ANTHROPIC_API_KEY secret to enable._" >> /tmp/claude_analysis.txt
            exit 0
          fi

          # Use Python for reliable JSON handling
          python3 << 'PYTHON_SCRIPT'
          import json
          import urllib.request
          import os

          # Read findings
          with open('/tmp/raw_findings.txt', 'r') as f:
              findings = f.read()

          prompt = """You are a smart contract security expert. Analyze the following findings from an automated audit and provide:

          1. **Executive Summary**: A paragraph with the overall security status of the contract
          2. **Critical Findings**: The 3-5 most important issues that must be fixed before deployment
          3. **Recommendations**: Concrete steps to fix each critical issue
          4. **Overall Risk**: Low/Medium/High/Critical with justification

          Be concise and practical. Focus on what really matters for security.

          AUDIT FINDINGS:
          """ + findings

          # Prepare request
          data = {
              "model": "claude-sonnet-4-20250514",
              "max_tokens": 2000,
              "messages": [{"role": "user", "content": prompt}]
          }

          headers = {
              "Content-Type": "application/json",
              "x-api-key": os.environ.get("ANTHROPIC_API_KEY", ""),
              "anthropic-version": "2023-06-01"
          }

          try:
              req = urllib.request.Request(
                  "https://api.anthropic.com/v1/messages",
                  data=json.dumps(data).encode('utf-8'),
                  headers=headers,
                  method='POST'
              )

              with urllib.request.urlopen(req, timeout=120) as response:
                  result = json.loads(response.read().decode('utf-8'))

              if "content" in result and len(result["content"]) > 0:
                  analysis = result["content"][0].get("text", "No analysis available")
              else:
                  analysis = f"Unexpected response: {json.dumps(result)[:500]}"

          except urllib.error.HTTPError as e:
              error_body = e.read().decode('utf-8')
              analysis = f"API Error {e.code}: {error_body[:500]}"
          except Exception as e:
              analysis = f"Error: {str(e)}"

          # Write analysis
          with open('/tmp/claude_analysis.txt', 'w') as f:
              f.write("## ðŸ¤– Claude Analysis\n\n")
              f.write(analysis)

          print("Claude analysis completed")
          PYTHON_SCRIPT

      - name: Post Combined Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let auditReport = '';
            let claudeAnalysis = '';

            try {
              auditReport = fs.readFileSync('/tmp/audit_report.txt', 'utf8');
            } catch (e) {
              auditReport = 'Error reading audit report.';
            }

            try {
              claudeAnalysis = fs.readFileSync('/tmp/claude_analysis.txt', 'utf8');
            } catch (e) {
              claudeAnalysis = '## ðŸ¤– Claude Analysis\n\n_Analysis not available._';
            }

            const fullReport = `# ðŸ” Security Audit Report

            Triggered by: @${{ github.event.comment.user.login }}

            ---

            ${claudeAnalysis}

            ---

            ## ðŸ› ï¸ Automated Findings (Slither + Aderyn + Slang)

            ${auditReport}

            ---

            _Generated by [Solidity Audit MCP](https://github.com/mariano-aguero/solidity-audit-mcp)_
            `;

            // Truncate if too long
            const maxLength = 60000;
            const report = fullReport.length > maxLength
              ? fullReport.substring(0, maxLength) + '\n\n... (truncated)'
              : fullReport;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
